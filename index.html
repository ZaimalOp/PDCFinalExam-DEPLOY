<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Systems Exam | Final Submission</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e1e1e; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-primary { background-color: #0d6efd; border: none; }
        .btn-success { background-color: #198754; border: none; }
        .log-window { background-color: #000; color: #0f0; font-family: 'Courier New', monospace; height: 300px; overflow-y: scroll; padding: 15px; border-radius: 5px; border: 1px solid #333; font-size: 0.9rem; }
        .status-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 12px; }
        .drop-zone { border: 2px dashed #444; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: #0d6efd; background-color: #1a1a1a; }
        .metric-card { background-color: #252525; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .metric-label { font-size: 0.8rem; color: #aaa; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="fw-bold"><i class="fas fa-network-wired"></i> Distributed Systems Exam</h1>
            <p class="text-muted">REST • tRPC • gRPC • Microservices</p>
            <span class="badge bg-success status-badge">System Online</span>
            <span class="badge bg-secondary status-badge">Vercel Deployment</span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card p-4 mb-4">
                <h4 class="mb-3"><i class="fas fa-upload"></i> Image Classification</h4>

                <div class="mb-3">
                    <label class="form-label text-muted">Select Protocol:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="protocol" id="protoRest" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="protoRest">REST</label>

                        <input type="radio" class="btn-check" name="protocol" id="protoTrpc" autocomplete="off">
                        <label class="btn btn-outline-primary" for="protoTrpc">tRPC</label>

                        <input type="radio" class="btn-check" name="protocol" id="protoGrpc" autocomplete="off">
                        <label class="btn btn-outline-primary" for="protoGrpc">gRPC</label>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-2 text-muted"></i>
                        <p class="mb-0 text-muted">Click to Upload Image</p>
                        <input type="file" id="fileInput" class="d-none" accept="image/*">
                    </div>
                    <p id="fileName" class="text-center mt-2 text-info small"></p>
                </div>

                <button class="btn btn-success w-100 py-2 fw-bold" onclick="runTest()">
                    <i class="fas fa-play"></i> RUN CLASSIFICATION
                </button>
            </div>

            <div class="row g-2">
                <div class="col-6">
                    <div class="metric-card">
                        <div class="metric-value" id="latencyVal">0 ms</div>
                        <div class="metric-label">Latency</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="metric-card">
                        <div class="metric-value" id="statusVal">Idle</div>
                        <div class="metric-label">Status</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card p-3 h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0"><i class="fas fa-terminal"></i> System Logs</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">Clear</button>
                </div>
                <div class="log-window" id="consoleLog">
                    <div>> System initialized...</div>
                    <div>> Waiting for input...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const logWindow = document.getElementById('consoleLog');

    function log(message, type = 'info') {
        const div = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString();
        div.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
        if (type === 'error') div.style.color = '#ff4d4d';
        if (type === 'success') div.style.color = '#00cc00';
        logWindow.appendChild(div);
        logWindow.scrollTop = logWindow.scrollHeight;
    }

    function clearLog() {
        logWindow.innerHTML = '<div>> Logs cleared.</div>';
    }

    document.getElementById('fileInput').addEventListener('change', function() {
        if(this.files[0]) document.getElementById('fileName').innerText = this.files[0].name;
    });

    async function runTest() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files[0]) {
            log('Error: No file selected.', 'error');
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('image', file);

        log(`Starting upload: ${file.name} (${(file.size/1024).toFixed(2)} KB)...`);
        document.getElementById('statusVal').innerText = "Processing...";

        const start = performance.now();

        try {
            // Note: In this Vercel demo, we route everything to the REST endpoint
            // because hosting tRPC/gRPC requires separate ports which Vercel serverless doesn't support easily.
            const response = await fetch('/uploadImage', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error(`Server Error: ${response.statusText}`);

            const data = await response.json();
            const end = performance.now();
            const latency = (end - start).toFixed(2);

            document.getElementById('latencyVal').innerText = `${latency} ms`;
            document.getElementById('statusVal').innerText = "Success";
            document.getElementById('statusVal').style.color = "#00cc00";

            log(`> Upload Complete. Time: ${latency}ms`, 'success');
            log(`> Classification Result:`, 'info');
            log(`&nbsp;&nbsp; Label: <b>${data.label}</b>`);
            log(`&nbsp;&nbsp; Confidence: <b>${data.confidence}</b>`);

        } catch (error) {
            log(`Error: ${error.message}`, 'error');
            document.getElementById('statusVal').innerText = "Error";
            document.getElementById('statusVal').style.color = "#ff4d4d";
        }
    }
</script>
</body>
</html>
